import express from 'express';
import cors from 'cors';
import rateLimit from 'express-rate-limit';
import * as dotenv from 'dotenv';

dotenv.config();

const app = express();
// Use a different default port than Vite to avoid conflicts
const PORT = process.env.PORT ? Number(process.env.PORT) : 8081;

app.use(express.json());

// Frontend origin (must be scheme://host:port). For this repo Vite defaults to :8080
const devOrigin = process.env.VITE_DEV_ORIGIN || 'http://localhost:8080';
app.use(
  cors({
    origin: devOrigin,
  })
);

// Basic rate limiter (tune for your usage)
const limiter = rateLimit({
  windowMs: 60_000, // 1 minute
  max: 30, // max requests per IP per windowMs
});
app.use(limiter);

app.post('/api/AIChat', async (req, res) => {
  try {
    const { question } = req.body;
    if (!question || typeof question !== 'string' || !question.trim()) {
      return res.status(400).json({ error: 'question (non-empty string) is required' });
    }

    const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
    if (!OPENAI_API_KEY) {
      console.error('OPENAI_API_KEY missing in environment');
      return res.status(500).json({ error: 'Server misconfiguration: OPENAI_API_KEY missing' });
    }

    // Temporary mock response for development when API quota is exceeded
    if (process.env.USE_MOCK_RESPONSE === 'true') {
      console.log('Using mock response for development');
      
      // Comprehensive healthcare-focused responses based on question content
      const lowerQuestion = question.toLowerCase();
      let mockAnswer = '';
      
      // Emergency and urgent conditions
      if (lowerQuestion.includes('chest pain') || lowerQuestion.includes('chest discomfort') || lowerQuestion.includes('heart attack') || lowerQuestion.includes('cardiac')) {
        mockAnswer = `üö® URGENT: Chest pain requires immediate medical attention!

Chest pain can indicate serious conditions like heart attack, angina, or other cardiac issues. 

IMMEDIATE ACTION REQUIRED:
‚Ä¢ If you have chest pain, pressure, or tightness - CALL 911 NOW
‚Ä¢ Don't wait to see if it gets better
‚Ä¢ Don't drive yourself to the hospital
‚Ä¢ Stay calm and follow emergency operator instructions

Common signs of heart attack:
‚Ä¢ Chest pain or pressure
‚Ä¢ Pain in arms, neck, jaw, or back
‚Ä¢ Shortness of breath
‚Ä¢ Nausea or vomiting
‚Ä¢ Cold sweat
‚Ä¢ Lightheadedness

‚ö†Ô∏è This is a medical emergency. Call 911 immediately for chest pain.

[This is a mock response - real AI would provide more detailed assessment]`;
      }
      // Headache and migraine
      else if (lowerQuestion.includes('headache') || lowerQuestion.includes('migraine') || lowerQuestion.includes('head pain')) {
        mockAnswer = `I understand you're experiencing a headache. Here's some helpful information:

COMMON HEADACHE TYPES:
‚Ä¢ Tension headaches: Mild to moderate pain, often stress-related
‚Ä¢ Migraines: Severe, throbbing pain, often with nausea/sensitivity to light
‚Ä¢ Cluster headaches: Intense pain around one eye

GENERAL RELIEF MEASURES:
‚Ä¢ Rest in a dark, quiet room
‚Ä¢ Apply cold compress to forehead
‚Ä¢ Stay hydrated
‚Ä¢ Gentle neck and shoulder stretches
‚Ä¢ Over-the-counter pain relievers (follow package instructions)

SEEK MEDICAL ATTENTION IF:
‚Ä¢ Sudden, severe headache (worst of your life)
‚Ä¢ Headache with fever, stiff neck, or rash
‚Ä¢ Headache after head injury
‚Ä¢ Changes in vision or speech
‚Ä¢ Weakness or numbness

‚ö†Ô∏è Always consult your healthcare provider for persistent or severe headaches.

[This is a mock response - real AI would provide more detailed guidance]`;
      }
      // Fever and temperature
      else if (lowerQuestion.includes('fever') || lowerQuestion.includes('temperature') || lowerQuestion.includes('hot')) {
        mockAnswer = `Fever management guidance:

NORMAL TEMPERATURE: 98.6¬∞F (37¬∞C)
FEVER: 100.4¬∞F (38¬∞C) or higher

FEVER MANAGEMENT:
‚Ä¢ Rest and stay hydrated
‚Ä¢ Light clothing and cool environment
‚Ä¢ Lukewarm baths (not cold)
‚Ä¢ Over-the-counter fever reducers (acetaminophen/ibuprofen)
‚Ä¢ Monitor temperature regularly

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Fever over 103¬∞F (39.4¬∞C)
‚Ä¢ Fever lasting more than 3 days
‚Ä¢ Fever with severe headache, stiff neck, or rash
‚Ä¢ Difficulty breathing
‚Ä¢ Signs of dehydration
‚Ä¢ Fever in infants under 3 months

‚ö†Ô∏è Always consult your healthcare provider for persistent fever or concerning symptoms.

[This is a mock response - real AI would provide more detailed fever management]`;
      }
      // Stomach and digestive issues
      else if (lowerQuestion.includes('stomach') || lowerQuestion.includes('nausea') || lowerQuestion.includes('vomit') || lowerQuestion.includes('diarrhea')) {
        mockAnswer = `Digestive issue guidance:

FOR NAUSEA/VOMITING:
‚Ä¢ Small sips of clear fluids (water, broth, electrolyte drinks)
‚Ä¢ Avoid solid foods initially
‚Ä¢ Rest and avoid strong smells
‚Ä¢ Ginger tea or ginger candies may help
‚Ä¢ BRAT diet when ready: Bananas, Rice, Applesauce, Toast

FOR DIARRHEA:
‚Ä¢ Stay hydrated with electrolyte solutions
‚Ä¢ Avoid dairy, caffeine, and fatty foods initially
‚Ä¢ Eat bland, low-fiber foods
‚Ä¢ Consider probiotics

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Severe dehydration (dry mouth, no urination, dizziness)
‚Ä¢ Blood in vomit or stool
‚Ä¢ Severe abdominal pain
‚Ä¢ High fever with digestive symptoms
‚Ä¢ Symptoms lasting more than 2-3 days

‚ö†Ô∏è Always consult your healthcare provider for persistent digestive issues.

[This is a mock response - real AI would provide more detailed digestive guidance]`;
      }
      // Sleep issues
      else if (lowerQuestion.includes('sleep') || lowerQuestion.includes('insomnia') || lowerQuestion.includes('tired') || lowerQuestion.includes('fatigue')) {
        mockAnswer = `Sleep and fatigue guidance:

HEALTHY SLEEP HABITS:
‚Ä¢ Consistent sleep schedule (same bedtime/wake time)
‚Ä¢ 7-9 hours of sleep per night
‚Ä¢ Cool, dark, quiet bedroom
‚Ä¢ No screens 1 hour before bed
‚Ä¢ Regular exercise (but not close to bedtime)
‚Ä¢ Limit caffeine after 2 PM
‚Ä¢ Avoid large meals before bed

SLEEP HYGIENE TIPS:
‚Ä¢ Relaxing bedtime routine
‚Ä¢ Comfortable mattress and pillows
‚Ä¢ White noise or earplugs if needed
‚Ä¢ Keep bedroom only for sleep and intimacy

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Chronic insomnia (3+ nights/week for 3+ months)
‚Ä¢ Excessive daytime sleepiness
‚Ä¢ Sleep apnea symptoms (snoring, gasping, frequent waking)
‚Ä¢ Restless leg syndrome

‚ö†Ô∏è Always consult your healthcare provider for persistent sleep issues.

[This is a mock response - real AI would provide more detailed sleep guidance]`;
      }
      // Medication questions
      else if (lowerQuestion.includes('medication') || lowerQuestion.includes('drug') || lowerQuestion.includes('pill') || lowerQuestion.includes('medicine')) {
        mockAnswer = `Medication safety guidance:

IMPORTANT MEDICATION PRINCIPLES:
‚Ä¢ Always follow your doctor's prescribed dosage and schedule
‚Ä¢ Read medication labels and instructions carefully
‚Ä¢ Never share medications with others
‚Ä¢ Store medications properly (cool, dry place, away from children)
‚Ä¢ Check expiration dates regularly
‚Ä¢ Inform all healthcare providers about all medications you take

DRUG INTERACTIONS:
‚Ä¢ Some medications can interact with each other
‚Ä¢ Some foods can affect medication absorption
‚Ä¢ Alcohol can interact with many medications
‚Ä¢ Always ask your pharmacist about potential interactions

SIDE EFFECTS:
‚Ä¢ Report any unusual symptoms to your healthcare provider
‚Ä¢ Some side effects are normal, others require immediate attention
‚Ä¢ Keep a medication diary if helpful

‚ö†Ô∏è Always consult your healthcare provider or pharmacist for medication-related questions.

[This is a mock response - real AI would provide more detailed medication guidance]`;
      }
      // Emergency situations
      else if (lowerQuestion.includes('emergency') || lowerQuestion.includes('urgent') || lowerQuestion.includes('help') || lowerQuestion.includes('911')) {
        mockAnswer = `üö® EMERGENCY GUIDANCE:

CALL 911 IMMEDIATELY FOR:
‚Ä¢ Chest pain or pressure
‚Ä¢ Difficulty breathing or shortness of breath
‚Ä¢ Severe bleeding that won't stop
‚Ä¢ Signs of stroke (facial drooping, arm weakness, speech difficulties)
‚Ä¢ Severe allergic reactions
‚Ä¢ Loss of consciousness
‚Ä¢ Severe burns or injuries
‚Ä¢ Suspected poisoning
‚Ä¢ Severe abdominal pain
‚Ä¢ High fever with stiff neck or rash

WHEN CALLING 911:
‚Ä¢ Stay calm and speak clearly
‚Ä¢ Provide your exact location
‚Ä¢ Describe the emergency
‚Ä¢ Follow the operator's instructions
‚Ä¢ Don't hang up until told to do so

NON-EMERGENCY URGENT CARE:
‚Ä¢ Contact your healthcare provider
‚Ä¢ Visit urgent care center
‚Ä¢ Use telehealth services if available

‚ö†Ô∏è When in doubt, call 911. It's better to be safe than sorry.

[This is a mock response - real AI would provide more detailed emergency guidance]`;
      }
      // General health and wellness
      else if (lowerQuestion.includes('exercise') || lowerQuestion.includes('workout') || lowerQuestion.includes('fitness')) {
        mockAnswer = `Exercise and fitness guidance:

RECOMMENDED EXERCISE:
‚Ä¢ 150 minutes of moderate-intensity aerobic activity per week
‚Ä¢ OR 75 minutes of vigorous-intensity activity per week
‚Ä¢ Muscle-strengthening activities 2+ days per week
‚Ä¢ Include flexibility and balance exercises

BENEFITS OF REGULAR EXERCISE:
‚Ä¢ Improved cardiovascular health
‚Ä¢ Stronger muscles and bones
‚Ä¢ Better mental health and mood
‚Ä¢ Weight management
‚Ä¢ Better sleep quality
‚Ä¢ Reduced risk of chronic diseases

EXERCISE SAFETY:
‚Ä¢ Start slowly and gradually increase intensity
‚Ä¢ Warm up before and cool down after
‚Ä¢ Stay hydrated
‚Ä¢ Listen to your body
‚Ä¢ Consult your doctor before starting new exercise programs

‚ö†Ô∏è Always consult your healthcare provider before starting a new exercise program.

[This is a mock response - real AI would provide more detailed fitness guidance]`;
      }
      // Nutrition and diet
      else if (lowerQuestion.includes('diet') || lowerQuestion.includes('food') || lowerQuestion.includes('nutrition') || lowerQuestion.includes('eat')) {
        mockAnswer = `Nutrition and diet guidance:

HEALTHY EATING PRINCIPLES:
‚Ä¢ Eat a variety of fruits and vegetables (5+ servings daily)
‚Ä¢ Choose whole grains over refined grains
‚Ä¢ Include lean proteins (fish, poultry, beans, nuts)
‚Ä¢ Limit saturated and trans fats
‚Ä¢ Reduce sodium intake
‚Ä¢ Stay hydrated with water
‚Ä¢ Limit added sugars

PORTION CONTROL:
‚Ä¢ Use smaller plates
‚Ä¢ Eat slowly and mindfully
‚Ä¢ Stop when you feel satisfied, not full
‚Ä¢ Read nutrition labels

SPECIAL DIETARY CONSIDERATIONS:
‚Ä¢ Consult a dietitian for specific dietary needs
‚Ä¢ Consider food allergies and intolerances
‚Ä¢ Some medical conditions require special diets

‚ö†Ô∏è Always consult your healthcare provider or registered dietitian for personalized nutrition advice.

[This is a mock response - real AI would provide more detailed nutrition guidance]`;
      }
      // Mental health and psychological conditions
      else if (lowerQuestion.includes('anxiety') || lowerQuestion.includes('depression') || lowerQuestion.includes('stress') || lowerQuestion.includes('mental') || lowerQuestion.includes('panic') || lowerQuestion.includes('bipolar') || lowerQuestion.includes('ptsd') || lowerQuestion.includes('ocd')) {
        mockAnswer = `Mental health support:

COMMON MENTAL HEALTH CONCERNS:
‚Ä¢ Anxiety: Excessive worry, restlessness, difficulty concentrating
‚Ä¢ Depression: Persistent sadness, loss of interest, fatigue
‚Ä¢ Stress: Feeling overwhelmed, irritable, difficulty sleeping
‚Ä¢ Panic attacks: Sudden intense fear with physical symptoms
‚Ä¢ Bipolar disorder: Extreme mood swings between depression and mania
‚Ä¢ PTSD: Flashbacks, nightmares after traumatic events
‚Ä¢ OCD: Obsessive thoughts and compulsive behaviors

COPING STRATEGIES:
‚Ä¢ Practice deep breathing and relaxation techniques
‚Ä¢ Maintain regular sleep schedule
‚Ä¢ Exercise regularly
‚Ä¢ Connect with supportive friends and family
‚Ä¢ Practice mindfulness or meditation
‚Ä¢ Limit alcohol and caffeine
‚Ä¢ Seek professional help when needed

WHEN TO SEEK HELP:
‚Ä¢ Persistent symptoms affecting daily life
‚Ä¢ Thoughts of self-harm or suicide
‚Ä¢ Difficulty functioning at work, school, or home
‚Ä¢ Substance use to cope with emotions

CRISIS RESOURCES:
‚Ä¢ National Suicide Prevention Lifeline: 988
‚Ä¢ Crisis Text Line: Text HOME to 741741
‚Ä¢ Emergency: Call 911

‚ö†Ô∏è Always consult mental health professionals for persistent mental health concerns.

[This is a mock response - real AI would provide more detailed mental health guidance]`;
      }
      // Respiratory conditions
      else if (lowerQuestion.includes('cough') || lowerQuestion.includes('breathing') || lowerQuestion.includes('asthma') || lowerQuestion.includes('bronchitis') || lowerQuestion.includes('pneumonia') || lowerQuestion.includes('respiratory')) {
        mockAnswer = `Respiratory health guidance:

COMMON RESPIRATORY CONDITIONS:
‚Ä¢ Asthma: Chronic airway inflammation causing wheezing and shortness of breath
‚Ä¢ Bronchitis: Inflammation of bronchial tubes, often with persistent cough
‚Ä¢ Pneumonia: Lung infection causing fever, cough, and difficulty breathing
‚Ä¢ COPD: Chronic obstructive pulmonary disease, often from smoking
‚Ä¢ Common cold: Viral infection with runny nose, cough, congestion

SYMPTOMS TO MONITOR:
‚Ä¢ Persistent cough (more than 2-3 weeks)
‚Ä¢ Shortness of breath or wheezing
‚Ä¢ Chest pain when breathing
‚Ä¢ High fever with respiratory symptoms
‚Ä¢ Coughing up blood or colored mucus

MANAGEMENT TIPS:
‚Ä¢ Stay hydrated and rest
‚Ä¢ Use humidifier for dry air
‚Ä¢ Avoid smoking and secondhand smoke
‚Ä¢ Practice deep breathing exercises
‚Ä¢ Use prescribed inhalers as directed

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Difficulty breathing or rapid breathing
‚Ä¢ High fever with respiratory symptoms
‚Ä¢ Persistent cough with blood
‚Ä¢ Severe chest pain
‚Ä¢ Blue lips or fingernails

‚ö†Ô∏è Always consult your healthcare provider for persistent respiratory symptoms.

[This is a mock response - real AI would provide more detailed respiratory guidance]`;
      }
      // Skin conditions
      else if (lowerQuestion.includes('skin') || lowerQuestion.includes('rash') || lowerQuestion.includes('acne') || lowerQuestion.includes('eczema') || lowerQuestion.includes('psoriasis') || lowerQuestion.includes('dermatitis') || lowerQuestion.includes('mole') || lowerQuestion.includes('wart')) {
        mockAnswer = `Skin health guidance:

COMMON SKIN CONDITIONS:
‚Ä¢ Acne: Clogged pores causing pimples, blackheads, whiteheads
‚Ä¢ Eczema (Atopic Dermatitis): Itchy, inflamed, dry skin patches
‚Ä¢ Psoriasis: Rapid skin cell growth causing thick, scaly patches
‚Ä¢ Contact Dermatitis: Skin reaction to irritants or allergens
‚Ä¢ Rosacea: Facial redness, visible blood vessels, sometimes bumps

SKIN CARE BASICS:
‚Ä¢ Gentle cleansing with mild soap
‚Ä¢ Moisturize regularly, especially after bathing
‚Ä¢ Use sunscreen (SPF 30+) daily
‚Ä¢ Avoid harsh scrubbing or picking
‚Ä¢ Keep skin clean and dry

WARNING SIGNS TO WATCH:
‚Ä¢ New or changing moles (ABCDE rule: Asymmetry, Border, Color, Diameter, Evolution)
‚Ä¢ Persistent rash that doesn't improve
‚Ä¢ Skin lesions that bleed or don't heal
‚Ä¢ Severe itching or pain
‚Ä¢ Signs of infection (redness, warmth, pus)

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Suspicious moles or skin changes
‚Ä¢ Severe or persistent rashes
‚Ä¢ Signs of skin infection
‚Ä¢ Skin conditions affecting daily life

‚ö†Ô∏è Always consult a dermatologist for persistent skin concerns.

[This is a mock response - real AI would provide more detailed dermatology guidance]`;
      }
      // Eye and vision problems
      else if (lowerQuestion.includes('eye') || lowerQuestion.includes('vision') || lowerQuestion.includes('blurry') || lowerQuestion.includes('glaucoma') || lowerQuestion.includes('cataract') || lowerQuestion.includes('conjunctivitis') || lowerQuestion.includes('dry eye')) {
        mockAnswer = `Eye and vision health guidance:

COMMON EYE CONDITIONS:
‚Ä¢ Dry Eye: Insufficient tear production causing irritation
‚Ä¢ Conjunctivitis (Pink Eye): Eye inflammation causing redness and discharge
‚Ä¢ Cataracts: Clouding of the eye's lens affecting vision
‚Ä¢ Glaucoma: Increased eye pressure damaging optic nerve
‚Ä¢ Macular Degeneration: Deterioration of central vision

VISION SYMPTOMS TO MONITOR:
‚Ä¢ Blurry or double vision
‚Ä¢ Sudden vision loss or changes
‚Ä¢ Eye pain or pressure
‚Ä¢ Redness, swelling, or discharge
‚Ä¢ Sensitivity to light
‚Ä¢ Seeing flashes or floaters

EYE CARE TIPS:
‚Ä¢ Regular eye exams (every 1-2 years)
‚Ä¢ Protect eyes from UV rays with sunglasses
‚Ä¢ Take breaks from screens (20-20-20 rule)
‚Ä¢ Don't rub eyes excessively
‚Ä¢ Use artificial tears for dry eyes

URGENT EYE SYMPTOMS:
‚Ä¢ Sudden vision loss
‚Ä¢ Severe eye pain
‚Ä¢ Eye injury or trauma
‚Ä¢ Seeing halos around lights
‚Ä¢ Severe headache with vision changes

‚ö†Ô∏è Always consult an ophthalmologist for vision changes or eye problems.

[This is a mock response - real AI would provide more detailed ophthalmology guidance]`;
      }
      // Ear, nose, and throat conditions
      else if (lowerQuestion.includes('ear') || lowerQuestion.includes('nose') || lowerQuestion.includes('throat') || lowerQuestion.includes('sinus') || lowerQuestion.includes('hearing') || lowerQuestion.includes('tinnitus') || lowerQuestion.includes('tonsil')) {
        mockAnswer = `Ear, Nose & Throat (ENT) health guidance:

COMMON ENT CONDITIONS:
‚Ä¢ Sinusitis: Inflammation of sinuses causing congestion and pressure
‚Ä¢ Ear Infections: Bacterial or viral infections causing ear pain
‚Ä¢ Tonsillitis: Inflammation of tonsils causing sore throat
‚Ä¢ Tinnitus: Ringing or buzzing in ears
‚Ä¢ Allergic Rhinitis: Hay fever causing sneezing and congestion

SYMPTOMS TO MONITOR:
‚Ä¢ Persistent ear pain or hearing loss
‚Ä¢ Severe sore throat with difficulty swallowing
‚Ä¢ Chronic nasal congestion or sinus pressure
‚Ä¢ Ringing or buzzing in ears
‚Ä¢ Frequent nosebleeds

MANAGEMENT TIPS:
‚Ä¢ Use saline nasal sprays for congestion
‚Ä¢ Apply warm compresses for sinus pressure
‚Ä¢ Stay hydrated to thin mucus
‚Ä¢ Avoid smoking and secondhand smoke
‚Ä¢ Use humidifier in dry environments

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Severe ear pain or hearing loss
‚Ä¢ Difficulty breathing or swallowing
‚Ä¢ Persistent fever with ENT symptoms
‚Ä¢ Severe headache with sinus pressure
‚Ä¢ Signs of infection (pus, severe pain)

‚ö†Ô∏è Always consult an ENT specialist for persistent ear, nose, or throat problems.

[This is a mock response - real AI would provide more detailed ENT guidance]`;
      }
      // Musculoskeletal conditions
      else if (lowerQuestion.includes('back pain') || lowerQuestion.includes('joint') || lowerQuestion.includes('arthritis') || lowerQuestion.includes('muscle') || lowerQuestion.includes('bone') || lowerQuestion.includes('spine') || lowerQuestion.includes('knee') || lowerQuestion.includes('shoulder')) {
        mockAnswer = `Musculoskeletal health guidance:

COMMON MUSCULOSKELETAL CONDITIONS:
‚Ä¢ Back Pain: Often from muscle strain, poor posture, or disc issues
‚Ä¢ Arthritis: Joint inflammation causing pain, stiffness, and swelling
‚Ä¢ Osteoporosis: Weakened bones increasing fracture risk
‚Ä¢ Muscle Strains: Overstretching or tearing of muscle fibers
‚Ä¢ Tendinitis: Inflammation of tendons causing pain and stiffness

PAIN MANAGEMENT:
‚Ä¢ Rest and avoid activities that worsen pain
‚Ä¢ Apply ice for acute injuries (first 48 hours)
‚Ä¢ Use heat for chronic pain and stiffness
‚Ä¢ Gentle stretching and range-of-motion exercises
‚Ä¢ Over-the-counter pain relievers as directed

PREVENTION STRATEGIES:
‚Ä¢ Maintain good posture
‚Ä¢ Regular exercise to strengthen muscles
‚Ä¢ Proper lifting techniques (lift with legs, not back)
‚Ä¢ Maintain healthy weight
‚Ä¢ Adequate calcium and vitamin D intake

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Severe or persistent pain
‚Ä¢ Pain with numbness or weakness
‚Ä¢ Difficulty walking or moving
‚Ä¢ Signs of fracture (severe pain, deformity, inability to move)
‚Ä¢ Pain that worsens at night

‚ö†Ô∏è Always consult your healthcare provider for persistent musculoskeletal pain.

[This is a mock response - real AI would provide more detailed musculoskeletal guidance]`;
      }
      // Neurological conditions
      else if (lowerQuestion.includes('dizzy') || lowerQuestion.includes('vertigo') || lowerQuestion.includes('seizure') || lowerQuestion.includes('epilepsy') || lowerQuestion.includes('migraine') || lowerQuestion.includes('stroke') || lowerQuestion.includes('neurological') || lowerQuestion.includes('numbness')) {
        mockAnswer = `Neurological health guidance:

COMMON NEUROLOGICAL CONDITIONS:
‚Ä¢ Migraine: Severe headaches often with nausea and light sensitivity
‚Ä¢ Vertigo/Dizziness: Sensation of spinning or loss of balance
‚Ä¢ Epilepsy: Recurrent seizures due to abnormal brain activity
‚Ä¢ Stroke: Brain damage from interrupted blood flow
‚Ä¢ Peripheral Neuropathy: Nerve damage causing numbness and tingling

SYMPTOMS TO MONITOR:
‚Ä¢ Severe headaches (especially sudden onset)
‚Ä¢ Dizziness or loss of balance
‚Ä¢ Numbness or tingling in limbs
‚Ä¢ Muscle weakness or paralysis
‚Ä¢ Changes in speech or vision
‚Ä¢ Seizures or loss of consciousness

URGENT NEUROLOGICAL SYMPTOMS (CALL 911):
‚Ä¢ Sudden severe headache (worst of your life)
‚Ä¢ Sudden weakness or numbness (especially on one side)
‚Ä¢ Sudden difficulty speaking or understanding
‚Ä¢ Sudden vision changes
‚Ä¢ Sudden severe dizziness or loss of balance
‚Ä¢ Seizure or loss of consciousness

MANAGEMENT TIPS:
‚Ä¢ Keep a headache diary to identify triggers
‚Ä¢ Stay hydrated and maintain regular sleep
‚Ä¢ Avoid known migraine triggers
‚Ä¢ Practice stress management techniques

‚ö†Ô∏è Always consult a neurologist for persistent neurological symptoms.

[This is a mock response - real AI would provide more detailed neurological guidance]`;
      }
      // Endocrine and metabolic conditions
      else if (lowerQuestion.includes('diabetes') || lowerQuestion.includes('thyroid') || lowerQuestion.includes('hormone') || lowerQuestion.includes('blood sugar') || lowerQuestion.includes('insulin') || lowerQuestion.includes('metabolism') || lowerQuestion.includes('weight')) {
        mockAnswer = `Endocrine and metabolic health guidance:

COMMON ENDOCRINE CONDITIONS:
‚Ä¢ Diabetes: High blood sugar due to insulin problems
‚Ä¢ Thyroid Disorders: Overactive (hyperthyroid) or underactive (hypothyroid) thyroid
‚Ä¢ Metabolic Syndrome: Cluster of conditions increasing heart disease risk
‚Ä¢ PCOS: Polycystic ovary syndrome affecting hormones and metabolism

SYMPTOMS TO MONITOR:
‚Ä¢ Frequent urination and excessive thirst (diabetes)
‚Ä¢ Unexplained weight changes
‚Ä¢ Fatigue and mood changes
‚Ä¢ Changes in appetite
‚Ä¢ Irregular menstrual cycles (women)

MANAGEMENT STRATEGIES:
‚Ä¢ Regular blood sugar monitoring (if diabetic)
‚Ä¢ Balanced diet with controlled carbohydrates
‚Ä¢ Regular physical activity
‚Ä¢ Medication adherence as prescribed
‚Ä¢ Regular medical check-ups

WARNING SIGNS:
‚Ä¢ Very high or very low blood sugar
‚Ä¢ Severe fatigue or weakness
‚Ä¢ Rapid weight changes
‚Ä¢ Changes in mental status

‚ö†Ô∏è Always consult an endocrinologist for diabetes, thyroid, or hormone-related concerns.

[This is a mock response - real AI would provide more detailed endocrine guidance]`;
      }
      // Women's health
      else if (lowerQuestion.includes('pregnancy') || lowerQuestion.includes('pregnant') || lowerQuestion.includes('menstrual') || lowerQuestion.includes('period') || lowerQuestion.includes('menopause') || lowerQuestion.includes('breast') || lowerQuestion.includes('gynecological') || lowerQuestion.includes('ovarian') || lowerQuestion.includes('uterine') || lowerQuestion.includes('morning sickness') || lowerQuestion.includes('prenatal')) {
        mockAnswer = `Women's health guidance:

COMMON WOMEN'S HEALTH CONCERNS:
‚Ä¢ Menstrual Irregularities: Changes in cycle length, flow, or symptoms
‚Ä¢ Pregnancy-related Issues: Morning sickness, complications, prenatal care
‚Ä¢ Menopause: Natural transition causing hormonal changes
‚Ä¢ Breast Health: Lumps, pain, or changes in breast tissue
‚Ä¢ PCOS: Polycystic ovary syndrome affecting hormones and fertility

IMPORTANT SCREENINGS:
‚Ä¢ Regular Pap smears (every 3-5 years)
‚Ä¢ Mammograms (starting age 40-50)
‚Ä¢ Breast self-exams monthly
‚Ä¢ Regular gynecological exams

PREGNANCY CARE:
‚Ä¢ Regular prenatal visits
‚Ä¢ Folic acid supplementation
‚Ä¢ Avoid alcohol, smoking, and certain medications
‚Ä¢ Maintain healthy weight and nutrition

MENOPAUSE MANAGEMENT:
‚Ä¢ Hormone replacement therapy (if appropriate)
‚Ä¢ Calcium and vitamin D for bone health
‚Ä¢ Regular exercise and healthy diet
‚Ä¢ Manage hot flashes and sleep disturbances

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Irregular menstrual cycles
‚Ä¢ Breast lumps or changes
‚Ä¢ Severe pelvic pain
‚Ä¢ Pregnancy complications
‚Ä¢ Severe menopause symptoms

‚ö†Ô∏è Always consult a gynecologist for women's health concerns.

[This is a mock response - real AI would provide more detailed women's health guidance]`;
      }
      // Men's health
      else if (lowerQuestion.includes('prostate') || lowerQuestion.includes('testosterone') || lowerQuestion.includes('erectile') || lowerQuestion.includes('male') || lowerQuestion.includes('andropause')) {
        mockAnswer = `Men's health guidance:

COMMON MEN'S HEALTH CONCERNS:
‚Ä¢ Prostate Health: Enlarged prostate (BPH) or prostate cancer
‚Ä¢ Low Testosterone: Decreased energy, libido, and muscle mass
‚Ä¢ Erectile Dysfunction: Difficulty achieving or maintaining erection
‚Ä¢ Heart Disease: Higher risk in men, especially with age
‚Ä¢ Mental Health: Often underdiagnosed in men

IMPORTANT SCREENINGS:
‚Ä¢ Prostate exams (starting age 50, or 45 for high risk)
‚Ä¢ Regular blood pressure and cholesterol checks
‚Ä¢ Testosterone level testing if symptoms present
‚Ä¢ Regular physical exams

LIFESTYLE FACTORS:
‚Ä¢ Regular exercise and strength training
‚Ä¢ Healthy diet with fruits, vegetables, and lean proteins
‚Ä¢ Limit alcohol consumption
‚Ä¢ Don't smoke
‚Ä¢ Manage stress effectively

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Urinary problems or changes
‚Ä¢ Erectile dysfunction
‚Ä¢ Low energy or mood changes
‚Ä¢ Chest pain or shortness of breath
‚Ä¢ Changes in testicular appearance

‚ö†Ô∏è Always consult a urologist or men's health specialist for specific concerns.

[This is a mock response - real AI would provide more detailed men's health guidance]`;
      }
      // Pediatric health
      else if (lowerQuestion.includes('baby') || lowerQuestion.includes('infant') || lowerQuestion.includes('child') || lowerQuestion.includes('pediatric') || lowerQuestion.includes('toddler') || lowerQuestion.includes('kids') || lowerQuestion.includes('vaccination') || lowerQuestion.includes('immunization')) {
        mockAnswer = `Pediatric health guidance:

COMMON PEDIATRIC CONCERNS:
‚Ä¢ Fever in Children: Common symptom requiring monitoring
‚Ä¢ Vaccinations: Essential for preventing serious diseases
‚Ä¢ Growth and Development: Monitoring milestones and nutrition
‚Ä¢ Common Childhood Illnesses: Colds, ear infections, stomach bugs
‚Ä¢ Safety: Preventing accidents and injuries

FEVER GUIDELINES:
‚Ä¢ Under 3 months: Any fever requires immediate medical attention
‚Ä¢ 3-6 months: Fever over 101¬∞F (38.3¬∞C) needs evaluation
‚Ä¢ 6+ months: Monitor symptoms, treat discomfort

VACCINATION SCHEDULE:
‚Ä¢ Follow CDC recommended schedule
‚Ä¢ Keep vaccination records updated
‚Ä¢ Discuss any concerns with pediatrician
‚Ä¢ Don't delay vaccinations without medical reason

GROWTH MONITORING:
‚Ä¢ Regular well-child visits
‚Ä¢ Track height, weight, and head circumference
‚Ä¢ Monitor developmental milestones
‚Ä¢ Address feeding and nutrition concerns

SAFETY PRIORITIES:
‚Ä¢ Childproof home environment
‚Ä¢ Use appropriate car seats and seatbelts
‚Ä¢ Supervise around water and stairs
‚Ä¢ Keep medications and chemicals locked away

‚ö†Ô∏è Always consult a pediatrician for children's health concerns.

[This is a mock response - real AI would provide more detailed pediatric guidance]`;
      }
      // Geriatric health
      else if (lowerQuestion.includes('elderly') || lowerQuestion.includes('senior') || lowerQuestion.includes('aging') || lowerQuestion.includes('dementia') || lowerQuestion.includes('alzheimer') || lowerQuestion.includes('falls') || lowerQuestion.includes('frailty')) {
        mockAnswer = `Geriatric health guidance:

COMMON GERIATRIC CONCERNS:
‚Ä¢ Dementia/Alzheimer's: Memory loss and cognitive decline
‚Ä¢ Falls Prevention: Major cause of injury in elderly
‚Ä¢ Medication Management: Multiple medications and interactions
‚Ä¢ Chronic Disease Management: Diabetes, heart disease, arthritis
‚Ä¢ Social Isolation: Impact on mental and physical health

FALL PREVENTION:
‚Ä¢ Remove tripping hazards at home
‚Ä¢ Improve lighting throughout house
‚Ä¢ Use assistive devices (canes, walkers) as needed
‚Ä¢ Regular exercise to maintain strength and balance
‚Ä¢ Regular vision and hearing checks

MEDICATION SAFETY:
‚Ä¢ Keep updated medication list
‚Ä¢ Use pill organizers
‚Ä¢ Regular medication reviews with doctor
‚Ä¢ Be aware of drug interactions
‚Ä¢ Don't share medications

COGNITIVE HEALTH:
‚Ä¢ Stay mentally active with puzzles, reading
‚Ä¢ Maintain social connections
‚Ä¢ Regular physical exercise
‚Ä¢ Healthy diet (Mediterranean diet recommended)
‚Ä¢ Manage chronic conditions well

SEEK MEDICAL ATTENTION FOR:
‚Ä¢ Memory problems or confusion
‚Ä¢ Frequent falls or balance issues
‚Ä¢ Medication side effects
‚Ä¢ Depression or social withdrawal
‚Ä¢ Difficulty with daily activities

‚ö†Ô∏è Always consult a geriatrician for elderly health concerns.

[This is a mock response - real AI would provide more detailed geriatric guidance]`;
      }
      // Default response for other questions
      else {
        mockAnswer = `Thank you for your health question: "${question}"

As Dr. HealthBot, I'm designed to provide general health information and guidance. Here's how I would typically help:

FOR YOUR SPECIFIC QUESTION:
I would analyze your question and provide evidence-based health information, suggest when to seek medical attention, and offer general wellness guidance while emphasizing the importance of professional medical consultation.

GENERAL HEALTH PRINCIPLES:
‚Ä¢ Listen to your body and don't ignore concerning symptoms
‚Ä¢ Maintain regular check-ups with your healthcare provider
‚Ä¢ Follow prescribed treatments and medications
‚Ä¢ Practice preventive care and healthy lifestyle habits
‚Ä¢ Seek immediate medical attention for emergencies

‚ö†Ô∏è IMPORTANT MEDICAL DISCLAIMER: I am not a replacement for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare professionals for serious medical concerns.

[This is a mock response - real AI would provide more specific guidance based on your question]`;
      }
      
      return res.status(200).json({ answer: mockAnswer });
    }

    const payload = {
      model: 'gpt-3.5-turbo',
      messages: [
        { 
          role: 'system', 
          content: `You are Dr. HealthBot, a knowledgeable healthcare AI assistant specializing in general medical information and health guidance. 

IMPORTANT MEDICAL DISCLAIMER: You are NOT a replacement for professional medical advice, diagnosis, or treatment. Always recommend consulting with qualified healthcare professionals for serious medical concerns.

Your expertise includes:
- General health information and wellness advice
- Common symptoms explanation and when to seek medical attention
- Medication information and interactions
- Preventive care and healthy lifestyle recommendations
- First aid and emergency guidance
- Chronic condition management support
- Mental health awareness and resources

Guidelines:
1. Always prioritize patient safety
2. Recommend professional medical consultation for serious symptoms
3. Provide evidence-based information when possible
4. Use clear, empathetic language
5. Include relevant disclaimers for medical advice
6. Suggest emergency services (911/emergency room) for urgent situations
7. Be supportive and non-judgmental
8. Focus on education and empowerment

Remember: You are a helpful assistant that provides general health information, not a licensed medical professional.` 
        },
        { role: 'user', content: question },
      ],
      max_tokens: 1000,
      temperature: 0.3,
    };

    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    if (!r.ok) {
      let errText = await r.text().catch(() => '');
      try {
        const parsed = JSON.parse(errText);
        errText = parsed?.error?.message || JSON.stringify(parsed);
      } catch (e) {
        // keep raw errText
      }
      console.error('OpenAI API returned error:', r.status, errText);
      return res.status(r.status).json({ error: `OpenAI API error: ${errText || r.statusText}` });
    }

    const data: any = await r.json().catch((e) => {
      console.error('Failed to parse OpenAI response JSON', e);
      return null;
    });

    const answer = data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.text ?? null;

    if (!answer) {
      console.error('No answer returned from OpenAI response:', JSON.stringify(data));
      return res.status(500).json({ error: 'No answer returned from AI' });
    }

    return res.status(200).json({ answer });
  } catch (err: any) {
    console.error('AI fetch failed:', err?.stack ?? err);
    return res.status(500).json({
      error: `Server error making AI request${process.env.NODE_ENV !== 'production' ? `: ${err?.message}` : ''}`
    });
  }
});

// Centralized JSON error fallback for any uncaught errors (helps prevent HTML 500 responses)
app.use((err: any, _req: any, res: any, _next: any) => {
  console.error('Unhandled error middleware:', err?.stack ?? err);
  res.status(500).json({ error: 'Internal server error' });
});

app.listen(PORT, () => {
  console.log(`AI server listening on http://localhost:${PORT}`);
});